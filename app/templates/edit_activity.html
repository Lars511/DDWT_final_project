{% extends "base.html" %}
{% block content %}

<h1>Edit Activity</h1>

<form method="POST">
    <label>Category</label><br>
    <select name="category_id" id="category_id" required>
        <option value="">Select a category</option>
        {% for category in categories %}
            <option value="{{ category.id }}"
                {% if category.id == activity.category_id %}selected{% endif %}>
                {{ category.name }}
            </option>
        {% endfor %}
    </select><br><br>
    <label>Activity Type</label><br>
    <select name="activity_type_id" id="activity_type_id" required>
        <option value="">Loading activity types...</option>
    </select><br><br>

    <label>Title</label><br>
    <input type="text" name="title" value="{{ activity.title }}" required><br><br>

    <label>Description</label><br>
    <textarea name="description">{{ activity.description }}</textarea><br><br>

    <label>Location</label><br>
    <input type="text" name="location" value="{{ activity.location }}" required><br><br>

    <label>Date</label><br>
    <input type="date" name="activity_date"
           value="{{ activity.activity_date }}" required><br><br>

    <label>Time</label><br>
    <input type="time" name="activity_time"
           value="{{ activity.activity_time }}" required><br><br>

    <label>Max participants</label><br>
    <input type="number" name="max_participants"
           value="{{ activity.max_participants }}" min="1"><br><br>

    <button type="submit">Update Activity</button>

</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const categorySelect = document.getElementById("category_id");
    const activityTypeSelect = document.getElementById("activity_type_id");

    const selectedCategoryId = "{{ activity.category_id }}";
    const selectedActivityTypeId = "{{ activity.activity_type_id }}";

    function loadActivityTypes(categoryId, selectedTypeId = null) {
        activityTypeSelect.innerHTML = '<option value="">Loading...</option>';

        fetch(`/api/activity-types/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                activityTypeSelect.innerHTML = '<option value="">Select activity type</option>';

                data.forEach(type => {
                    const option = document.createElement("option");
                    option.value = type.id;
                    option.textContent = type.name;

                    if (selectedTypeId && type.id == selectedTypeId) {
                        option.selected = true;
                    }

                    activityTypeSelect.appendChild(option);
                });
            })
            .catch(() => {
                activityTypeSelect.innerHTML = '<option value="">Error loading activity types</option>';
            });
    }

    // load activity types immediately on page load
    if (selectedCategoryId) {
        loadActivityTypes(selectedCategoryId, selectedActivityTypeId);
    }

    // reload activity types when category changes
    categorySelect.addEventListener("change", function () {
        if (this.value) {
            loadActivityTypes(this.value);
        } else {
            activityTypeSelect.innerHTML = '<option value="">Select a category first</option>';
        }
    });
});
</script>

{% endblock %}
